---
title: 'OHI 2021: Seagrass trend explore'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '../../../workflow/templates/ohi_hdr.html'
  pdf_document:
    toc: true
---


```{r setup, include=FALSE}

library(readr)      # for read_csv()
library(raster)
library(here)
library(sf)
library(fasterize)
library(tidyverse)
library(broom)

source('http://ohi-science.org/ohiprep_v2021/workflow/R/common.R')

goal     <- 'globalprep/hab_seagrass/v2021'
dir_git  <- file.path('~/github/ohiprep_v2021', goal)
dir_waycott <- file.path(dir_git, "waycott_data_extract")


```


"Trend in seagrass condition was determined using two data sources (Waycott et al. 2009, Short et al. 2010). Short et al. (2010) measured percent cover on a per sample, per site, per year basis, whereas Waycott et al. (2009) measured habitat area on a per site, per year basis. We used data from Short if there were at least 3 data points between 2001-2010. If this condition was not met, we calculated trends from Waycott for the most recent 10 years after 1990 or else we used the mean of the trend in the adjacent regions or the regions within the corresponding seagrass geographical regions using the same methods described above for the in status."

## Waycott data 
Let's take a look at the Waycott and short data... extracted in 2016

```{r}
waycott_data <- read_csv(file.path("~/github/ohiprep_v2021/globalprep/hab_seagrass/v2016_explore/data1/data_waycott.csv"))
summary(waycott_data)

waycott_trend <- waycott_data %>%
 dplyr::filter(year >= 1990,
               !is.na(area_ha),
               area_ha != 0) %>%
 dplyr::group_by(site_id, rgn, site_name) %>%
 dplyr::mutate(year_length = max(year) - min(year)) %>%
  dplyr::mutate(min_year = min(year)) %>%
  dplyr::filter(year_length >= 10) %>%
 dplyr::mutate(extent_rel = area_ha/area_ha[year == min_year]) %>%
 dplyr::do(mdl = lm(extent_rel ~ year, data=.)) %>%
  dplyr::summarize(country = rgn,
                   site_name = site_name, 
                   site_id = site_id,
            habitat = "seagrass",
            trend = coef(mdl)['year']*5) %>%
  dplyr::mutate(trend = round(trend, 6)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(country, habitat) %>%
  dplyr::summarise(trend = mean(trend, na.rm = TRUE)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(data_source = "Waycott")

unique(waycott_trend$country) # 4 regions - we ultimately only use 1 (france).. see Short data below
# [1] "Australia" "Colombia"  "France"    "USA"


short_data <- read_csv(file.path("~/github/ohiprep_v2021/globalprep/hab_seagrass/v2016_explore/data1/data_short.csv")) %>%
  mutate(sg_prop_mean = sg_pct_mean/100)

## Filter out those where the first year has an extent of 0... these screw up the trend calculation later on..
short_0s <- short_data %>%
   dplyr::group_by(site_name, country) %>%
  dplyr::mutate(min_year = min(year)) %>%
  dplyr::mutate(n_obs = n()) %>%
  dplyr::filter(n_obs >= 3) %>%
   dplyr::mutate(prop_rel = sg_prop_mean/sg_prop_mean[year == min_year]) %>%
  dplyr::filter(prop_rel %in% c("Inf", "NaN")|site_name == "Oregon / Valino Island, South Slough") %>% ## fix oregon site outlier..
  dplyr::filter(site_name != "Zadar / Novigradsko More") %>% ## filter out zadar bc without the first one it doesnt have more than 3 observations
  dplyr::filter(sg_prop_mean > 0.0003) %>% ## filter out this observation because it totally screws up the USA trend as an outlier... 
  dplyr::mutate(min_year = min(year),
                n_obs = n()) %>%
  dplyr::mutate(prop_rel = sg_prop_mean/sg_prop_mean[year == min_year]) ## now recalculate with the correct number of observations for those site


short_trend <- short_data %>%
  dplyr::filter(!(site_name %in% c("Zadar / Novigradsko More", "New York / Fire Is., Long Island", "Glovers Reef Atoll", "Oregon / Valino Island, South Slough"))) %>%
 dplyr::group_by(site_name, country) %>%
  dplyr::mutate(min_year = min(year)) %>%
  dplyr::mutate(n_obs = n()) %>%
  dplyr::filter(n_obs >= 3) %>% 
 dplyr::mutate(prop_rel = sg_prop_mean/sg_prop_mean[year == min_year]) %>%
  rbind(short_0s) %>% ## rbind with the outlier fixes
 dplyr::do(mdl = lm(prop_rel ~ year, data=.)) %>%
  dplyr::summarize(country = country,
                   site_name = site_name, 
            habitat = "seagrass",
            trend = coef(mdl)['year']*5) %>%
  dplyr::mutate(trend = round(trend, 6)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(country = ifelse(is.na(country), "United States of America", country)) %>% # fix massachussettes
  dplyr::group_by(country, habitat) %>%
  dplyr::summarise(trend = mean(trend, na.rm = TRUE)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(data_source = "Short")

unique(short_trend$country)

#  [1] "Australia"                        "Belize"                           "Brazil"                          
#  [4] "China"                            "Colombia"                         "Fiji"                            
#  [7] "Indonesia"                        "Madagascar"                       "Malaysia"                        
# [10] "Micronesia (Federated States of)" "Palau"                            "Papua New Guinea"                
# [13] "Philippines"                      "Portugal"                         "Thailand"                        
# [16] "United Republic of Tanzania"      "United States of America" 

waycott_trend_using <- waycott_trend %>%
  dplyr::filter(country == "France")

all_trend <- rbind(short_trend, waycott_trend_using)

old_trend <- read_csv(file.path("~/github/ohiprep_v2021/globalprep/hab_seagrass/v2012/data/habitat_trend_seagrass_updated.csv")) %>%
  left_join(rgns_eez)
```

```{r}
short_data_raw <- read_csv(file.path("~/github/ohiprep_v2021/globalprep/hab_seagrass/v2016_explore/data0/short_latlong.csv"))

```


